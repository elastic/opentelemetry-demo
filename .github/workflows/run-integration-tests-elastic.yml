name: Elastic Integration Tests

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '.github/README.md'

permissions:
  contents: read

jobs:
  run-tests:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo docker builder prune -a

    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Compose
      uses: docker/setup-compose-action@v1
      with:
          version: latest
    
    - name: Create k8s Kind Cluster
      uses: helm/kind-action@v1
    
    - name: Set up helm
      uses: azure/setup-helm@v4.3.0

    - name: Install bashunit
      run: |
        curl -s https://bashunit.typeddevs.com/install.sh | bash -s bin

    # - name: Check env files
    #   run: |
    #     echo "=== .env.override ==="
    #     cat .env.override
    #     echo ""
    #     echo "=== .env IMAGE_NAME ==="
    #     grep "IMAGE_NAME" .env || echo "Not in .env"

    # - name: Create compose override
    #   run: |
    #     cat > docker-compose.override.yml << 'EOF'
    #     services:
    #       opensearch:
    #         deploy:
    #           replicas: 0
    #
    #       otel-collector:
    #         depends_on:
    #           jaeger:
    #             condition: service_started
    #
    #       product-catalog:
    #         deploy:
    #           resources:
    #             limits:
    #               memory: 100M
    #         environment:
    #           - PRODUCT_CATALOG_PORT
    #           - PRODUCT_CATALOG_RELOAD_INTERVAL
    #           - FLAGD_HOST
    #           - FLAGD_PORT
    #           - GOMEMLIMIT=80MiB
    #           - OTEL_EXPORTER_OTLP_ENDPOINT
    #           - OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE
    #           - OTEL_RESOURCE_ATTRIBUTES
    #           - OTEL_SERVICE_NAME=product-catalog
    #     EOF
    #
    #     echo "=== Override file ==="
    #     cat docker-compose.override.yml
    #     echo ""
    #     echo "=== Merged config for product-catalog ==="
    #     docker compose config | grep -A 30 "product-catalog:"

    - name: Debug working directory
      run: |
        echo "=== PWD ==="
        pwd
        echo ""
        echo "=== .env files in current dir ==="
        ls -la .env* || echo "No .env files here"
        echo ""
        echo "=== .env files in repo root ==="
        ls -la $GITHUB_WORKSPACE/.env* || echo "No .env files there"

    - name: Debug launch path
      run: |
        echo "=== What does make start run? ==="
        make -n start
        echo ""
        echo "=== Check if demo.sh uses make ==="
        grep -n "make" demo.sh || echo "make not found in demo.sh"
        echo ""
        echo "=== Check start_docker function ==="
        grep -A 10 "start_docker()" demo.sh || true

    - name: Debug env file handling
      run: |
        echo "=== Docker compose version ==="
        docker compose version
        echo ""
        echo "=== Local docker compose version ==="
        echo "(for comparison - check your local version)"
        echo ""
        echo "=== .env content ==="
        cat .env | grep -E "^IMAGE" || true
        echo ""
        echo "=== .env.override content ==="
        cat .env.override | grep -E "^IMAGE" || true
        echo ""
        echo "=== Test: which value wins? ==="
        docker compose --env-file .env --env-file .env.override config 2>/dev/null | grep "image:" | head -5

    - name: Debug env files
      run: |
        echo "=== Current directory ==="
        pwd
        echo "=== List env files ==="
        ls -la .env*
        echo "=== .env contents ==="
        cat .env
        echo "=== .env.override contents ==="
        cat .env.override
        echo "=== Docker Compose resolved config ==="
        docker compose --env-file .env --env-file .env.override config 2>&1 | grep -i "image" | head -20

    # - name: Fix image name
    #   run: |
    #     sed -i 's|^IMAGE_NAME=.*|IMAGE_NAME=ghcr.io/elastic/opentelemetry-demo|' .env

    - name: Run the tests
      id: tests
      continue-on-error: true
      run: |
        ./bin/bashunit --env .env.bashunit

    - name: Check ES vars
      if: always()
      run: cat /tmp/es_debug.log 2>/dev/null || echo "No debug log"

    - name: Check ES vars demo
      if: always()
      run: cat /tmp/es_debug_demo.log 2>/dev/null || echo "No debug demo log"


    - name: Show launch debug
      if: always()
      run: |
        cat /tmp/launch_debug.log 2>/dev/null || echo "No debug log found"

    - name: Debug after launch
      run: |
        echo "=== .env after launch ==="
        grep "IMAGE_NAME" .env
        echo ""
        echo "=== .env.override after launch ==="
        grep "IMAGE_NAME" .env.override
        echo ""
        echo "=== Running containers ==="
        docker ps --format '{{.Names}}\t{{.Image}}' | head -10

    - name: Show container images
      if: always()
      run: |
        echo "=== Container Images ==="
        docker ps -a --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}' | head -30

    - name: Debug failed containers
      if: steps.tests.outcome == 'failure'
      run: |
        echo "=== product-catalog memory limit ==="
        docker inspect product-catalog --format '{{.HostConfig.Memory}}' || true
        echo ""
        echo "=== product-catalog all env vars ==="
        docker inspect product-catalog --format '{{range .Config.Env}}{{println .}}{{end}}' || true

        echo "=== Container Status ==="
        docker ps -a
        echo ""
        for container in $(docker ps -a --format '{{.Names}}'); do
          status=$(docker inspect "$container" --format '{{.State.Status}} exit:{{.State.ExitCode}}')
          if [[ ! "$status" =~ ^running ]]; then
            echo "=== $container ($status) ==="
            docker logs "$container" 2>&1 | tail -50
            echo ""
            echo "=== $container inspect ==="
            docker inspect "$container" --format 'Error: {{.State.Error}}'
            docker inspect "$container" --format 'OOMKilled: {{.State.OOMKilled}}'
            docker inspect "$container" --format 'Env: {{range .Config.Env}}{{println .}}{{end}}' | grep -E '(OTEL|CATALOG|SERVICE)' || true
            echo ""
          fi
        done

    - name: Fail if tests failed
      if: steps.tests.outcome == 'failure'
      run: exit 1
